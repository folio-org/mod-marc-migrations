# Application + Infrastructure services for mod-marc-migrations
# This compose file includes both the mod-marc-migrations module and all infrastructure dependencies
# Use this for full local testing and development with scalable module instances

include:
  - infra-docker-compose.yml

services:
  mod-marc-migrations:
    image: dev.folio/mod-marc-migrations
    build:
      context: ../
      dockerfile: Dockerfile
    ports:
      - "8081" # Allow Docker to dynamically assign a host port
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      ENV: ${ENV}
      JAVA_OPTIONS: -Xmx512m -Xms256m
      OKAPI_URL: ${OKAPI_URL}
      SYSTEM_USER_PASSWORD: mod-marc-migrations
      S3_REGION: ${S3_REGION}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
      S3_URL: ${S3_URL}
      S3_BUCKET: ${S3_BUCKET}
      RECORDS_CHUNK_SIZE: ${RECORDS_CHUNK_SIZE}
      CHUNK_FETCH_IDS_COUNT: ${CHUNK_FETCH_IDS_COUNT}
      CHUNK_PERSIST_COUNT: ${CHUNK_PERSIST_COUNT}
    volumes:
      - ./generated:/usr/verticles/${S3_LOCAL_SUB_PATH}
    depends_on:
      - api-mock
      - postgres
      - mod-entities-links
      - minio
      - kafka-topic-init
    networks:
      - mod-marc-migrations-local
    deploy:
      replicas: ${MODULE_REPLICAS:-1}
      restart_policy:
        condition: on-failure
      update_config:
        parallelism: 1
        delay: 10s
      resources:
        limits:
          cpus: "1.0"
          memory: "1024M"
        reservations:
          cpus: "0.5"
          memory: "512M"

networks:
  mod-marc-migrations-local:
    driver: bridge

